# Auto Rect Shape for Adobe After Effects

## 概要

**kg_autorect.jsx** は、選択したレイヤーのバウンディングボックスに合わせた長方形シェイプレイヤーを自動生成するAfter Effects用スクリプトです。テキストやシェイプの背景ボックスを素早く作成する際に便利です。

### バージョン
- 現在: **v1.3.4**

---

## 主な機能

| 機能 | 説明 |
|------|------|
| **自動フィット** | 選択レイヤーのバウンディングボックスに合わせた長方形を生成 |
| **回転・スケール対応** | 親レイヤーが回転・スケールされていても正確にフィット |
| **パディング** | 長方形の余白を指定可能 |
| **角丸** | 角の丸みを指定可能 |
| **フィル/ストローク** | 塗りと線の有無を選択可能 |
| **ベイク機能** | エクスプレッションを静的な値に変換 |

---

## インストール方法

1. `kg_autorect.jsx` を保存
2. 以下のフォルダに配置:
   - **Windows**: `C:\Program Files\Adobe\Adobe After Effects <version>\Support Files\Scripts\ScriptUI Panels\`
   - **macOS**: `/Applications/Adobe After Effects <version>/Scripts/ScriptUI Panels/`
3. After Effectsを再起動
4. `ウィンドウ` → `kg_autorect` で開く

---

## 使い方

### 基本的な使い方

1. バウンディングボックスを作成したいレイヤーを選択
2. **Options** で設定:
   - **Default Padding**: 余白（px）
   - **Default Roundness**: 角丸（px）
   - **Add Fill**: 塗りを追加
   - **Add Stroke**: 線を追加（線幅も設定可能）
3. **Create (Fit)** をクリック

### ベイク機能

エクスプレッションを削除して静的なシェイプに変換します。

1. 作成したAutoRectシェイプレイヤーを選択
2. **Bake (Static)** をクリック
3. 現在のフレームの値で固定され、エクスプレッションが削除される

---

## UI解説

### Options パネル

| 項目 | 説明 |
|------|------|
| **Default Padding** | 長方形とレイヤーの間の余白（px） |
| **Default Roundness** | 角の丸み（px） |
| **Add Fill** | チェックで白い塗りを追加 |
| **Add Stroke** | チェックで黒い線を追加 |
| **Stroke** | 線の太さ（px） |

### ボタン

| ボタン | 機能 |
|--------|------|
| **Create (Fit)** | 選択レイヤーに合わせた長方形を作成 |
| **Bake (Static)** | エクスプレッションを削除して静的な値に変換 |

---

## 生成されるレイヤー構造

### 作成されるシェイプレイヤー

- **名前**: `AutoRect - [元レイヤー名]`
- **位置**: 元レイヤーの直下（背面）
- **デュレーション**: 元レイヤーのイン/アウトポイントに一致

### シェイプ構造

```
AutoRect - [レイヤー名]
└── Contents
    └── AutoRect (グループ)
        ├── Rect (長方形パス)
        ├── Fill (塗り) ※オプション
        └── Stroke (線) ※オプション
```

---

## 仕組み

### sourceRectAtTimeの活用

スクリプトは `sourceRectAtTime()` を使用して、レイヤーの実際のバウンディングボックスを取得します。これにより：

- テキストレイヤーのテキスト変更に対応
- シェイプレイヤーのパス変更に対応
- マスクされた領域を考慮

### 座標変換

```javascript
// レイヤーローカル座標をコンポ座標に変換
var tlC = t.toComp([r.left, r.top]);
var trC = t.toComp([r.left + r.width, r.top]);
var blC = t.toComp([r.left, r.top + r.height]);
var brC = t.toComp([r.left + r.width, r.top + r.height]);

// コンポ座標からシェイプのローカル座標に変換
var tl = fromComp(tlC);
```

この2段階の変換により、元レイヤーが回転・スケールされていても正確にフィットします。

---

## トラブルシューティング

| 問題 | 原因 | 解決策 |
|------|------|--------|
| 長方形が作成されない | sourceRectAtTimeが使えないレイヤー | 画像やソリッドには対応していません |
| サイズが合わない | 元レイヤーのアンカーポイント | 元レイヤーのアンカーポイントを確認 |
| ベイクできない | AutoRectレイヤーを選択していない | 名前が「AutoRect - 」で始まるレイヤーを選択 |

---

## ライセンス

このスクリプトはフリーで使用できます。

---

## 更新履歴

| バージョン | 内容 |
|-----------|------|
| 1.3.4 | 回転・スケールに対応した座標変換 |
| 1.3.0 | Fill/Stroke オプション追加 |
| 1.2.0 | ベイク機能追加 |
| 1.0.0 | 初期リリース |
