# Custom Wiggle Property for Adobe After Effects

## 概要

**kg_CustomWiggleProperty.jsx** は、任意のプロパティに特別なwiggleまたは累積エクスプレッションを適用するスクリプトです。kg_WiggleTransformと異なり、位置・スケール・回転以外の任意のプロパティ（不透明度、エフェクトパラメータなど）にも適用できます。

### バージョン
- 現在: **v1.1.2**

---

## 主な機能

| 機能 | 説明 |
|------|------|
| **任意のプロパティ対応** | 位置・スケール・回転だけでなく、どんなプロパティにも適用可能 |
| **2つのモード** | Wiggle（ランダムな揺れ）と累積（連続的に増加）を選択可能 |
| **端で大きく変化** | レイヤーのイン/アウトポイント付近で変化が大きくなる |
| **コントロール方式選択** | ヌルオブジェクト or レイヤー本体でパラメータを制御 |
| **複数プロパティ対応** | 複数のプロパティを同時に選択して適用可能 |

---

## インストール方法

1. `kg_CustomWiggleProperty.jsx` を保存
2. 以下のフォルダに配置:
   - **Windows**: `C:\Program Files\Adobe\Adobe After Effects <version>\Support Files\Scripts\`
   - **macOS**: `/Applications/Adobe After Effects <version>/Scripts/`
3. After Effectsで `ファイル` → `スクリプト` → `スクリプトファイルを実行` で実行

---

## 使い方

### 基本的な使い方

1. タイムラインでプロパティを選択（位置、回転、不透明度、エフェクトのスライダーなど）
2. スクリプトを実行
3. ダイアログで設定を確認・調整
4. **OK** をクリック

### プロパティの選択方法

After Effectsのタイムラインパネルで、適用したいプロパティをクリックして選択します：

- 単一プロパティ: クリックで選択
- 複数プロパティ: Cmd/Ctrl + クリックで追加選択

---

## アニメーションモード

### Wiggleモード（ランダムな揺れ）

通常のwiggleと同様に、ランダムに値が変動します。

**用途例**:
- 位置の微振動
- 不透明度のちらつき
- エフェクトパラメータのランダム変動

### 累積モード（連続的に増加）

値が時間とともに累積的に増加します。方向（+/-）はランダムに決定されます。

**用途例**:
- 回転の連続回転（ぐるぐる回る）
- スケールの連続拡大/縮小
- 任意の値の増減アニメーション

---

## ダイアログ設定

### 選択されたプロパティ

適用対象のプロパティ一覧が表示されます。

### アニメーションモード

| モード | 説明 |
|--------|------|
| **Wiggle** | ランダムな揺れ |
| **累積** | 連続的に増加・回転/展開向け |

### コントロール方式

| 方式 | 説明 |
|------|------|
| **ヌルオブジェクトで制御** | 複数レイヤー一括調整向け。共通のコントロールヌルが作成される |
| **レイヤー本体で制御** | 個別調整向け。各レイヤーに個別のエフェクトが追加される |

### デフォルト設定

#### Wiggleモードの場合

| 項目 | 説明 | デフォルト |
|------|------|-----------|
| **端の振幅** | 始点/終点での変動幅 | 50 |
| **中央の振幅** | 中央部分での変動幅 | 5 |
| **端の範囲 (%)** | 端とみなす範囲 | 5% |

#### 累積モードの場合

| 項目 | 説明 | デフォルト |
|------|------|-----------|
| **端の速度** | 始点/終点での変化速度（単位/秒） | 360 |
| **中央の速度** | 中央部分での変化速度 | 30 |
| **端の範囲 (%)** | 端とみなす範囲 | 5% |

---

## 適用後のコントロール

### ヌルオブジェクト制御の場合

「Wiggle Control」または「Accumulate Control」という名前のヌルが作成され、以下のエフェクトが追加されます：

#### Wiggleモード

| コントロール | 説明 |
|-------------|------|
| **Posterize Time** | フレームレート |
| **端の範囲 (%)** | 端とみなす範囲（0-50%） |
| **中央の周波数** | 中央部分のwiggle速度 |
| **端の周波数** | 端部分のwiggle速度 |
| **中央の振幅** | 中央部分の変動幅 |
| **端の振幅** | 端部分の変動幅 |

#### 累積モード

| コントロール | 説明 |
|-------------|------|
| **Posterize Time** | フレームレート |
| **端の範囲 (%)** | 端とみなす範囲（0-50%） |
| **中央の速度** | 中央部分の変化速度 |
| **端の速度** | 端部分の変化速度 |

### レイヤー本体制御の場合

各レイヤーに同様のエフェクトが追加されます。同じレイヤーに複数回適用した場合、エフェクト名にサフィックス（ 2, 3...）が付きます。

---

## 使用例

### 不透明度のちらつき

1. レイヤーの「不透明度」プロパティを選択
2. スクリプトを実行
3. Wiggleモードを選択
4. 端の振幅: 30、中央の振幅: 5

### 回転の連続回転

1. レイヤーの「回転」プロパティを選択
2. スクリプトを実行
3. 累積モードを選択
4. 端の速度: 720（秒速2回転）、中央の速度: 90

### エフェクトパラメータのランダム化

1. エフェクトのスライダーやポイントを選択
2. スクリプトを実行
3. 設定を調整して適用

---

## 累積モードの仕組み

累積モードでは、各フレームの速度を積分して値を計算します：

```javascript
// 累積値を計算
var accumulatedValue = 0;
for (var t = startTime; t < currentTime; t += frameTime) {
    // その時点での速度を取得
    var currentSpeed = calculateSpeed(t);
    // 速度 × 時間 = 変位を累積
    accumulatedValue += currentSpeed * frameTime * direction;
}

// 元の値に累積値を加算
value + accumulatedValue;
```

---

## トラブルシューティング

| 問題 | 原因 | 解決策 |
|------|------|--------|
| プロパティが選択されていない | プロパティが選択されていない | タイムラインでプロパティを直接クリック |
| エクスプレッション適用不可 | 読み取り専用のプロパティ | 編集可能なプロパティを選択 |
| 累積モードで動きが遅い | posterizeTimeが高い | Posterize Timeを下げる |
| 変化が見えない | 振幅/速度が小さい | 端の振幅/速度を大きくする |

### デバッグ

スクリプトはExtendScript Toolkitのコンソールにログを出力します。問題が発生した場合はコンソールを確認してください。

---

## kg_WiggleTransformとの違い

| 項目 | kg_WiggleTransform | kg_CustomWiggleProperty |
|------|-------------------|------------------------|
| **対象プロパティ** | 位置・スケール・回転のみ | 任意のプロパティ |
| **アニメーションモード** | Wiggleのみ | Wiggle + 累積 |
| **プロパティ選択** | ダイアログで選択 | タイムラインで事前選択 |
| **実行方法** | パネルスクリプト可 | スクリプト実行のみ |

---

## ライセンス

このスクリプトはフリーで使用できます。

---

## 更新履歴

| バージョン | 内容 |
|-----------|------|
| 1.1.2 | レイヤー本体制御時のサフィックス対応 |
| 1.1.0 | 累積モード追加、コントロール方式選択 |
| 1.0.0 | 初期リリース |
